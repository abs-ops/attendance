# 1、概述

&emsp;&emsp;考勤平台是公司施小宝产品平台下负责考勤业务管理的一个子平台，平台立足于公司大平台，面向企业考勤业务，架构起整个企业考勤机网络系统，可以对企业各部门员工实现7*24小时方位无死角考勤。下面这幅图是展示了考勤系统在整个平台中的位置。


![考勤平台在施小宝平台中的位置概览](/assets/image/20170808185922.png "考勤平台在施小宝平台中的位置概览")




# 2、业务架构

## 2.1、概述

&emsp;&emsp;考勤系统目前提供两大块内容：1、实现企业考勤管理。2、实现企业LED广告投放。

## 2.2、企业考勤管理

&emsp;&emsp;可以实现对企业各部门管辖的工作人员在各时间段实施差异化考勤管理。

## 2.3、企业LED广告投放管理

&emsp;&emsp;可以实现对企业各部门管辖的LED设备各时间段投放的广告内容实施管理。


# 3、技术架构

&emsp;&emsp;针对考勤系统整体需求特点，技术实现上，我们将考勤系统划分为考勤应用系统(简称考勤系统,attendance-app)、考勤设备网关系统(简称设备网关,attendance-device)。两者关系如下图所示。

![考勤业务架构概览](/assets/image/20170808145254.png "考勤业务架构概览")

## 3.1、考勤应用系统

&emsp;&emsp;考勤应用系统是整个考勤系统的系统中枢，它通过消息队列将操作指令下发给硬件网关系统，并通过消息队列获取硬件网关系统转发过来的考勤流水记录、设备状态信息。

&emsp;&emsp;考勤应用系统接收到硬件网关系统转发过来的考勤流水记录后，经过考勤规则过滤层清洗后，进入有效考勤记录数据库中，方便企业实时获取这些考勤信息，也可以在考勤信息清洗完成时实时通知给相关部门的管理人员。

&emsp;&emsp;考勤应用系统接收到硬件网关系统转发过来的设备状态信息后，实时存储到时序数据库，运维监控系统可以实时监测设备的运行状态是否良好。

&emsp;&emsp;管理人员可以根据企业各部门的具体业务需要定制不同的考勤规则，考勤系统系统会将部门-人员身份证对应信息下发到硬件网关，网关进而将这些信息下发到中控设备辖区的特定考勤机上。

&emsp;&emsp;管理人员可以根据企业部门具体业务需要定制各部门辖区内的LED设备所投放的广告信息内容，考勤系统会将部门-LED对应信息下发到硬件网关，硬件网关进而通过中控设备将广告信息投放到指定的LED设备上。

&emsp;&emsp;管理人员可以在考勤系统上实时获取到自己部门内部员工的的考勤信息。

&emsp;&emsp;管理人员可以在考勤系统上实时获取到自己部门管辖范围内的考勤机、LED设备的在线状态信息。


## 3.2、考勤设备网关系统

&emsp;&emsp;硬件网关是所有中控设备的中枢，它通过消息中间件与考勤应用系统交互，控制着所有连接到它上面的中控设备、中控设备上的考勤机、LED设备。

&emsp;&emsp;硬件网关的数据主要集中存储在硬件网关系统独立管辖的MongoDB和Redis中。人脸母版信息、来自考勤应用系统的信息都会被存储Mongodb中，硬件网关根据实际需要会将匹配的信息下发到被中控设备管辖的考勤机、LED上。 设备状态信息、设备网络路由信息等会被存储到Redis中。 

&emsp;&emsp;硬件网关会将考勤记录、设备状态信息以5min/次的频率通过消息队列(MQ)实时发送给考勤系统。考勤记录信息是增量信息，设备状态信息是全量信息。


# 4、数据架构

## 4.1、关系型数据库

### 4.1.1、概述

&emsp;&emsp;考虑到MySQL数据库是目前全球最流行的开源数据库，基于MySQL的分布式开源数据库中间件比较成熟，故而平台采用MySQL数据库做为平台关系型数据库存储主体。

&emsp;&emsp;考勤平台主要的数据模型及其关系如下图所示。

![考勤平台数据模型概览](/assets/image/20170811151041.png "考勤平台数据模型概览")

&emsp;&emsp;按功能，可以将上图数据模型划分为企业域、设备域、考勤域、公告域四个域。


>约定
>
>PK    - 主键
>
>FK    - 外键
>
>NN    - 非空
>
>UN    - 唯一约束
>
>是否删除    -逻辑删除标记符，用于标记是否已经删除，true表示已删除，faluse表示未删除。
>
>是否启用    -启用/禁用标记符，用于标记已启用还是已禁用，true表示已启用，faluse表示已禁用。
>
>创建时间    -记录创建时间标记符，用于标记记录什么时候创建。
>
>修改时间    -记录修改时间标记符，用于标记记录什么时候修改。
>
>创建者    -记录创建者标记符，用于标记记录被谁创建。
>
>创建者    -记录修改者标记符，用于标记记录被谁修改。



### 4.1.2、企业域


![考勤平台企业域数据模型](/assets/image/20170811151121.png "考勤平台企业域数据模型")


### 4.1.2.1、企业信息表

&emsp;&emsp;企业信息表用于存储企业用户信息。

&emsp;&emsp;企业账号用于登录系统，管理企业。

&emsp;&emsp;营业期限，分为长期和短期。

### 4.1.2.2、部门信息表

&emsp;&emsp;部门信息表用于存储部门信息。

&emsp;&emsp;直属部门表示当前部门的直接上级部门。

&emsp;&emsp;部门路径代表从顶级部门所在节点到当前部门所在节点的节点名称集合。该字段用于辅助查询，以减少sql的查询次数。

&emsp;&emsp;部门优先级用于在界面上显示的时候进行排序。


### 4.1.2.3、员工信息表

&emsp;&emsp;员工信息表用于存储员工用户信息。

&emsp;&emsp;员工账号用于登录系统。

&emsp;&emsp;归属企业表示当前员工归属于哪个企业，关联到企业信息表的企业编号。


### 4.1.3、设备域
![考勤平台设备域数据模型](/assets/image/20170811151158.png "考勤平台设备域数据模型")



### 4.1.3、考勤域
![考勤平台考勤域数据模型](/assets/image/20170811151232.png "考勤平台考勤域数据模型")



### 4.1.3、公告域
![考勤平台公告域数据模型](/assets/image/20170811151306.png "考勤平台公告域数据模型")



## 4.2、NoSQL数据库


### 4.2.1、Redis


### 4.2.2、MongoDB


### 4.2.3、Memcached

&emsp;&emsp;Memcached 是一个高性能的分布式内存对象缓存系统，用于动态Web应用以减轻数据库负载。它通过在内存中缓存数据和对象来减少读取数据库的次数，从而提高动态、数据库驱动网站的速度。Memcached基于一个存储键/值对的hashmap。考虑到在性能上Memcached优于Redis，但是不支持数据持久化到硬盘的特点，可以用它缓存一些性能上要求高，状态无关的数据。比如考勤系统中的部门树，部门树中部门-员工、部门-设备信息就可以缓存到Memcached中，只有当他们的关系发生变化的时候，才刷新一下Memcached。


## 4.3、搜索引擎

&emsp;&emsp;考勤到考勤系统中，通常会有一些基于名称的模糊搜索，模糊搜索对于关系型数据库来说，效率不是很高，这个时候，可以将这些名称信息交给搜索引擎建立索引，查询的时候就可以提高系统性能。

## 4.4、资源服务器

&emsp;&emsp;考勤系统中的企业营业执照、企业logo信息会集中存放到资源服务器中，企业信息表中只存储相应的url信息。


# 5、平台组织架构

## 5.1、客户管理系统(Customer mananger System,CMS)

&emsp;&emsp;考勤应用系统，主要提供给企业管理管理人员用于企业内部考勤管理。


## 5.2、客户服务系统(Customer Service System,CSS)

&emsp;&emsp;考勤客服系统，主要提供给客服人员完成企业信息的管理。


## 5.3、设备网关系统(Device Gateway System,DGS)

&emsp;&emsp;设备网关系统主要用于集中管理中控设备，将中控设备管辖的考勤机、LED的信息与考勤应用系统、考勤客服系统做关联起来。


### 5.3.1、对管理端接口

1、考勤机-部门

2、部门-人员

3、led-广告

4、部门-led-广告


### 5.3.2、对设备端接口


1、考勤机-部门

2、部门-人员

3、led-广告

4、数据上传





## 5.4、设备控制系统(Device Control System,DCS)

&emsp;&emsp;设备驱动系统主要用于驱动中控设备管理考勤机、LED设备。



# 6、部署架构

## 6.1、CDN服务器


## 6.2、反向代理


## 6.3、负责均衡


## 6.4、应用服务器集群


## 6.5、分布式数据库集群


## 6.6、NoSQL数据库集群


## 6.7、搜索引擎集群


## 6.8、日志处理服务器集群


